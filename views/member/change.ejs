<!DOCTYPE html>
<html lang="ko">

<head>
  <% include ../static/head.ejs %>

    <style>
      .heading-icon h4 {
        display: inline;
        margin-right: 3pc;
      }
      /*.team-image img{*/
      /*width: 360px;*/
      /*height: 230px;*/
      /*}*/
    </style>


    <script type="text/javascript" src="//developers.band.us/js/share/band-button.js?v=28052017"></script>

    <link rel="stylesheet" href="/lib/js-canvas/css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="/lib/js-canvas/css/responsive.css" type="text/css" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- 다음 우편번호 api-->
    <script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>

</head>


<body class="stretched">
  <div id="wrapper" class="clearfix">

    <!-- HEADER -->
    <% include ../addon/header2.ejs %>

      <!-- Content
     ============================================= -->
      <section id="content">

        <div class="content-wrap">

          <div class="container clearfix">

            <form class="nobottommargin" id="change-form" name="template-contactform" method="post">
              <div class="row clearfix">

                <div class="col-sm-9">

                  <img src="<%= mediaUrl + profile_image_path %>" class="alignleft img-circle img-thumbnail notopmargin nobottommargin" alt="Avatar"
                    style="max-width: 84px;">

                  <div class="heading-block noborder">
                    <h3>
                      <%= nickname %><span></span></h3>
                    <!--<span>Your Profile Bio</span>-->
                    <div class="heading-icon">
                      <h4><i class="icon-line-heart"> <%= userLikeCount %> </i></h4>
                      <h4><i class=icon-star> <%= __("memberType")[member_type] %> </i></h4>
                    </div>

                    <div class="clear"></div>

                  </div>

                  <div class="col-md-6 bottommargin">
                    <label>Basic Select File</label><br>
                    <!-- <input id="input-1" type="file" class="file"> -->
                    <div class="kv-avatar center-block text-center" style="width:200px">
                      <input id="profile" name="profile" type="file" class="file-loading">
                      <input id="profile_src" name="profile_src" type="hidden" value="<%= profile_image_path %>" />
                    </div>
                  </div>

                  <div class="col-md-3 bottommargin">
                    <label for="nickname">닉네임</label><br>
                    <input type="text" id="nickname" name="nickname" value="<%= nickname %>" class="sm-form-control required show-error-msg"
                    />
                  </div>

                  <div class="col-md-3 bottommargin">
                    <label for="phone">Phone</label><br>
                    <input type="text" id="phone" name="phone" value="<%= phone %>" class="sm-form-control show-error-msg" />
                  </div>

                  <div class="clear"></div>

                  <!-- -->
                  <% if(member_type!='PUBLIC'){ %>

                    <div class="postcontent nobottommargin">

                      <div class="contact-widget">

                        <div class="contact-form-result"></div>

                        <div class="form-process"></div>

                        <div class="col_one_third">
                          <label for="template-contactform-service">사업주 정보</label>
                          <select id="template-contactform-service" name="template-contactform-service" class="sm-form-control">
                        <option value="">-- Select One --</option>
                        <option value="Wordpress">Wordpress</option>
                        <option value="PHP / MySQL">PHP / MySQL</option>
                        <option value="HTML5 / CSS3">HTML5 / CSS3</option>
                        <option value="Graphic Design">Graphic Design</option>
                      </select>
                        </div>

                        <div class="col_one_third">
                          <label for="registered_number">사업자 등록번호<small>*</small></label>
                          <input type="text" id="registered_number" name="registered_number" value="<%= registered_number %>" class="sm-form-control required show-error-msg"
                          />
                        </div>

                        <div class="col_one_third col_last">
                          <label for="template-contactform-email">대표명<small>*</small></label>
                          <input type="email" id="template-contactform-email" name="template-contactform-email" value="" class="required email sm-form-control"
                          />
                        </div>

                        <div class="clear"></div>

                      </div>

                    </div>

                    <div class="clear"></div>

                    <div class="container clearfix">
                      <div class="col-sm-9" style="margin-bottom: 20px;">
                        <input type="text" id="sample4_postcode" name="post_code" value="<%= post_code %>" placeholder="우편번호">
                        <input type="button" onclick="sample4_execDaumPostcode()" value="우편번호 찾기"><br>
                        <input type="text" id="sample4_roadAddress" name="addr1" value="<%= addr1 %>" placeholder="도로명주소">
                        <input type="text" id="sample4_jibunAddress" name="addr2" value="<%= addr2 %>" placeholder="지번주소">
                        <span id="guide" style="color:#999"></span>
                      </div>
                    </div>

                    <div class="clear"></div>

                   
                    <% } %>
                      <!-- -->
                      <div class="container clearfix">
                        <div class="col-sm-9">

                          <!-- Contact Form Overlay
                    ============================================= -->
                          <div id="contact-form" class="clearfix">

                            <div class="contact-widget">

                              <div class="contact-form-result"></div>

                              <!-- Contact Form
                        ============================================= -->
                              <form class="nobottommargin" id="template-contactform" name="template-contactform" action="include/sendemail.php" method="post">

                                <div class="col_full">
                                  <label for="website">Website</label>
                                  <input type="text" id="website" name="website" value="<%= sns.website %>" class="sm-form-control" />
                                </div>

                                <div class="col_full">
                                  <label for="facebook">Facebook</label>
                                  <input type="email" id="facebook" name="facebook" value="<%= sns.facebook %>" class="email sm-form-control"
                                  />
                                </div>

                                <div class="clear"></div>

                                <div class="col_full">
                                  <label for="instagram">instagram</label>
                                  <input type="text" id="instagram" name="instagram" value="<%= sns.instagram %>" class="sm-form-control" />
                                </div>


                                <div class="clear"></div>

                                <div class="col_full">
                                  <label for="twitters">twitter</label>
                                  <input type="text" id="twitter" name="twitter" value="<%= sns.twitter %>" class="sm-form-control"
                                  />
                                </div>

                                <div class="col_full">
                                  <label for="about">Message</label>
                                  <textarea class="sm-form-control" id="about" name="about" rows="6" cols="30"><%= about %></textarea>
                                </div>

                                <div class="col_full hidden">
                                  <input type="text" id="template-contactform-botcheck" name="template-contactform-botcheck" value="" class="sm-form-control"
                                  />
                                </div>

                                <div class="col-sm-6">
                                  <button class="button button-3d button-rounded button-green" type="submit" id="template-contactform-submit" name="template-contactform-submit"
                                    value="submit">Submit</button>
                                </div>

                                <div class="col-sm-6">
                                  <button class="button button-3d button-rounded button-amber" type="submit" id="template-contactform-submit" name="template-contactform-submit"
                                    value="submit" style="float:right;">계정삭제</button>
                                </div>

                              </form>

                            </div>

                          </div>
                          <!-- Contact Form Overlay End -->

                        </div>
                      </div>


                      <!--<div class="row clearfix">-->

                      <!--<div class="col-md-12">-->

                      <!--<div class="tabs tabs-alt clearfix" id="tabs-profile">-->

                      <!--<ul class="tab-nav clearfix">-->
                      <!--<li><a href="#tab-follower">Follower</a></li>-->
                      <!--<li><a href="#tab-following">Following</a></li>-->
                      <!--<li><a href="#tab-posts">posts</a></li>-->
                      <!--<li><a href="#tab-replies">replies</a></li>-->
                      <!--<li><a href="#tab-likeposts">likeposts</a></li>-->
                      <!--</ul>-->

                      <!--<div class="tab-container">-->

                      <!--<div class="tab-content clearfix" id="tab-follower"></div>-->
                      <!--<div class="tab-content clearfix" id="tab-following"></div>-->
                      <!--<div class="tab-content clearfix" id="tab-posts"></div>-->
                      <!--<div class="tab-content clearfix" id="tab-replies"></div>-->
                      <!--<div class="tab-content clearfix" id="tab-likeposts"></div>-->


                      <!--</div>-->

                      <!--</div>-->

                      <!--</div>-->

                      <!--</div>-->

                </div>

                <div class="line visible-xs-block"></div>

                <div class="col-sm-3 clearfix">

                  <% include ./right-side.ejs %>




                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
      <!-- #content end -->


      <!--<a href="#myModal1"  data-lightbox="inline" class="button button-large button-rounded">Trigger Modal</a>-->

      <!--<div id="cropModal" style="display:none;">-->
      <!--&lt;!&ndash; crop 이미지 &ndash;&gt;-->
      <!--<img id="cropImg" />-->
      <!--&lt;!&ndash; 버튼들 &ndash;&gt;-->
      <!--<button class="button button-3d button-rounded button-red" type="submit" id="template-contactform-submit" name="template-contactform-submit" value="submit">취소</button>-->
      <!--<button class="button button-3d button-rounded button-blue" type="submit" id="template-contactform-submit" name="template-contactform-submit" value="submit">확인</button>-->
      <!--</div>-->
      <!--<div class="modal-on-load" data-target="#myModal1"></div>-->

      <!-- 모달 폼 -->
      <div class="mfp-hide" id="cropModal">
        <div class="block divcenter">
          <div class="center" style="width: 500px; height: 500px;">
            <div id="crop-InnerModal" style="width: 500px; height: 500px; position: fixed; left: 33%;">
              <!-- crop 이미지 -->
              <img id="cropImg" />
              <!-- 버튼들 -->
              <button class="button button-3d button-rounded button-red" type="submit" id="template-contactform-submit" name="template-contactform-submit"
                value="submit">취소</button>
              <button class="button button-3d button-rounded button-blue" type="submit" id="template-contactform-submit" name="template-contactform-submit"
                value="submit">확인</button>
            </div>
          </div>

        </div>
      </div>

  </div>
  <!-- wrapper.clearfix -->

  <footer>
    <!-- FOOTER -->
    <% include ../addon/footer.ejs %>
  </footer>


  <!-- LOAD JAVASCRIPT -->
  <% include ../static/js.ejs %>
  <div id="gotoTop" class="icon-angle-up"></div>

  <!--<script>-->
  <!--jQuery(function($) {-->
  <!--function getAjax(link) {-->
  <!--var memberIdx = window.location.href.split('#')[0].split('/');-->
  <!--memberIdx = memberIdx[memberIdx.length - 1];-->

  <!--$.ajax({-->
  <!--url: 'http://localhost:3000/api/user/' + memberIdx + '/json/' + link,-->
  <!--success: function(result) {-->
  <!--$('#tab-' + link).html(new EJS({url: '/template/user/info-' + link + '.ejs'}).render({data: result}));-->
  <!--SEMICOLON.widget.loadFlexSlider();-->
  <!--SEMICOLON.portfolio.arrange();-->
  <!--}-->
  <!--});-->
  <!--}-->

  <!--$('.tab-nav li a').click(function() {-->
  <!--let link = $(this).attr('href').split('-')[1];-->
  <!--getAjax(link);-->
  <!--});-->

  <!--getAjax('follower');-->
  <!--});-->
  <!--</script>-->

  <link rel="stylesheet" href="/lib/js-canvas/css/components/bs-filestyle.css" type="text/css" />
  <script type="text/javascript" src="/lib/js-canvas/js/components/bs-filestyle.js"></script>

  <!-- Cropper JS -->
  <link rel="stylesheet" href="/lib/cropperjs/cropper.css" />
  <script src="/lib/cropperjs/cropper.js"></script>

  <script>
    //본 예제에서는 도로명 주소 표기 방식에 대한 법령에 따라, 내려오는 데이터를 조합하여 올바른 주소를 구성하는 방법을 설명합니다.
    function sample4_execDaumPostcode() {
      new daum.Postcode({
        oncomplete: function (data) {
          // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

          // 도로명 주소의 노출 규칙에 따라 주소를 조합한다.
          // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
          var fullRoadAddr = data.roadAddress; // 도로명 주소 변수
          var extraRoadAddr = ''; // 도로명 조합형 주소 변수

          // 법정동명이 있을 경우 추가한다. (법정리는 제외)
          // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
          if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
            extraRoadAddr += data.bname;
          }
          // 건물명이 있고, 공동주택일 경우 추가한다.
          if (data.buildingName !== '' && data.apartment === 'Y') {
            extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }
          // 도로명, 지번 조합형 주소가 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
          if (extraRoadAddr !== '') {
            extraRoadAddr = ' (' + extraRoadAddr + ')';
          }
          // 도로명, 지번 주소의 유무에 따라 해당 조합형 주소를 추가한다.
          if (fullRoadAddr !== '') {
            fullRoadAddr += extraRoadAddr;
          }

          // 우편번호와 주소 정보를 해당 필드에 넣는다.
          document.getElementById('sample4_postcode').value = data.zonecode; //5자리 새우편번호 사용
          document.getElementById('sample4_roadAddress').value = fullRoadAddr;
          document.getElementById('sample4_jibunAddress').value = data.jibunAddress;

          // 사용자가 '선택 안함'을 클릭한 경우, 예상 주소라는 표시를 해준다.
          if (data.autoRoadAddress) {
            //예상되는 도로명 주소에 조합형 주소를 추가한다.
            var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
            document.getElementById('guide').innerHTML = '(예상 도로명 주소 : ' + expRoadAddr + ')';

          } else if (data.autoJibunAddress) {
            var expJibunAddr = data.autoJibunAddress;
            document.getElementById('guide').innerHTML = '(예상 지번 주소 : ' + expJibunAddr + ')';

          } else {
            document.getElementById('guide').innerHTML = '';
          }
        }
      }).open();
    }
  </script>

  <script>
    var $profileImg = $("#profile");
    var $cropInnerModal = $('#crop-InnerModal');
    var cropper;
    var orgFileBase;

    $profileImg.fileinput({
      overwriteInitial: true,
      showClose: false,
      showCaption: false,
      browseOnZoneClick: true,
      browseLabel: 'browse',
      removeLabel: 'remove',
      browseIcon: '<i class="icon-folder-open"></i>',
      removeIcon: '<i class="icon-remove"></i>',
      removeTitle: 'Cancel or reset changes',
      elErrorContainer: '#kv-avatar-errors-1',
      msgErrorClass: 'alert alert-block alert-danger',
      defaultPreviewContent: '<img src="<%= mediaUrl + profile_image_path %>" alt="Your Avatar" style="width:160px">',
      layoutTemplates: { main2: '{preview} {remove} {browse}' },
      allowedFileTypes: ['image'],
      allowedFileExtensions: ["jpg", "png"]
    });

    $profileImg.on('change', function (event, numFiles, label) {
      var originalURL;
      var file = document.querySelector('input[type=file]').files[0];
      var reader = new FileReader();

      reader.addEventListener("load", function (e) {
        var base64 = e.target.result;
        orgFileBase = base64;

        /* BASE64 STRING IMAGE BINDING */
        // preview.src = base64;

        /* BLOB URL IMAGE BINDING */
        // preview.src = window.URL.createObjectURL(base64StringToBlob(base64));
        originalURL = window.URL.createObjectURL(base64StringToBlob(base64));

        $(".file-preview-thumbnails .file-preview-frame").click((event, target) => {
          console.log("clicked");

          $.magnificPopup.open({
            items: {
              src: $("#cropModal"),
              type: 'inline',
              mainClass: 'mfp-no-margins mfp-fade',
              closeBtnInside: false,
              fixedContentPos: true,
              overflowY: 'scroll',
              modal: true
            }
          });

          createCropView(originalURL);
        });

      }, false);

      reader.onerror = function (error) {
        console.log('Error: ', error);
      };

      if (file) {
        reader.readAsDataURL(file);
      }
    });

    function binaryStringToArrayBuffer(binary) {
      var length = binary.length;
      var buf = new ArrayBuffer(length);
      var arr = new Uint8Array(buf);
      for (var i = 0; i < length; i++) {
        arr[i] = binary.charCodeAt(i);
      }
      return buf;
    }

    function base64StringToBlob(base64) {
      var type = base64.match(/data:([^;]+)/)[1];
      base64 = base64.replace(/^[^,]+,/g, '');
      var options = {};
      if (type) {
        options.type = type;
      }
      var binaryArrayBuffer = [binaryStringToArrayBuffer(window.atob(base64))];
      return new Blob(binaryArrayBuffer, options);
    }

    function createCropView(data) {
      var $croppedImage = $('#crop-InnerModal').find('#cropImg').attr('src', data);

      if (cropper) {
        cropper.destroy();
      }

      cropper = new Cropper($croppedImage[0], {
        aspectRatio: 1 / 1,
        // autoCropArea: 0,
        // strict: true,
        // guides: false,
        // highlight: false,
        // dragCrop: false,
        // cropBoxMovable: false,
        // cropBoxResizable: false,
        // preview: '.img-preview',
        crop: function (e) {
          // $dataX.val(Math.round(e.x));
          // $dataY.val(Math.round(e.y));
          // $dataHeight.val(Math.round(e.height));
          // $dataWidth.val(Math.round(e.width));
          // $dataRotate.val(e.rotate);
          // $dataScaleX.val(e.scaleX);
          // $dataScaleY.val(e.scaleY);
        }
      });
    }

    // profile image crop 성공
    $cropInnerModal.find('button.button-blue').click(function () {
      var preview = document.querySelector('.file-preview img');

      let croppedDataURL = cropper.getCroppedCanvas({ width: 150, height: 150 }).toDataURL();
      preview.src = window.URL.createObjectURL(base64StringToBlob(croppedDataURL));

      $.magnificPopup.close();
    });

    // profile image crop 취소
    $cropInnerModal.find('button.button-red').click(function () {
      // alert('취소');
      $.magnificPopup.close();
    });

    // 전송
    $('button.button-green').click(function () {

      if ($('.file-preview-frame img').attr('src')) {
        var blobData;

        if (cropper) {
          let croppedDataURL = cropper.getCroppedCanvas({ width: 150, height: 150 }).toDataURL();
          blobData = base64StringToBlob(croppedDataURL);
        } else if (orgFileBase) {
          blobData = base64StringToBlob(orgFileBase);
        }

        // console.log('blobData', blobData);
        var fd = new FormData();
        fd.append('filename', $('.file-footer-caption')[0].title);
        fd.append('profile_images', blobData);

        $.ajax({
          type: 'POST',
          url: '<%= mediaUrl %>/convert/profile',
          data: fd,
          headers: { authorization: $.cookie("authorization"), },
          processData: false,
          contentType: false
        }).done(function (data) {
          $profile_src = $('#profile_src');
          $profile_src.attr('value', data.url);
          // console.log($profile_src.attr('value'));
          $('form#change-form').submit();
        });
      } else {
        $('form#change-form').submit();
      }

      return false;
    });

    // 취소
    $('button.button-amber').click(function () {
      if (confirm("삭제하시겠습니까?")) {
        $.ajax({
          type: 'DELETE',
          url: '/user/delete',
          headers: { authorization: $.cookie("authorization"), },
        }).done(function (data) {
          if (data == 'OK') location.href = '/auth/logout';
        });
      }

      return false;
    });
  </script>


</body>

</html>